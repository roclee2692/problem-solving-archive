<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>LCA 可视化</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: sans-serif; }
  .node circle { fill: lightblue; stroke: #333; stroke-width: 2px; }
  .node text { font-size: 14px; }
  .link { fill: none; stroke: #666; stroke-width: 2px; }
  .highlight { fill: orange !important; }
  table, th, td { border: 1px solid black; border-collapse: collapse; padding: 4px; }
</style>
</head>
<body>

<h2>LCA 倍增可视化</h2>
<textarea id="edges" rows="5" cols="40">
1 2
1 3
2 4
2 5
3 6
3 7
</textarea><br>
根节点: <input id="root" type="number" value="1">
查询 (a b): <input id="query" value="4 5">
<button onclick="run()">运行</button>

<svg id="tree" width="800" height="500"></svg>
<div id="log"></div>
<div>
  <h3>up 表</h3>
  <table id="upTable"></table>
</div>

<script>
function run(){
    const edgesInput = document.getElementById('edges').value.trim().split('\n');
    const root = parseInt(document.getElementById('root').value);
    const [qa,qb] = document.getElementById('query').value.split(' ').map(Number);

    // 构造树
    let adj = {};
    edgesInput.forEach(line=>{
        let [u,v] = line.trim().split(' ').map(Number);
        if(!adj[u]) adj[u]=[];
        if(!adj[v]) adj[v]=[];
        adj[u].push(v);
        adj[v].push(u);
    });

    let LOGN = 5;
    let depth = {}, up={}, dist={};
    for(let i in adj){
        up[i] = Array(LOGN+1).fill(0);
        depth[i]=0; dist[i]=0;
    }

    // DFS + 倍增表
    function dfs(u,p){
        up[u][0] = p;
        for(let i=1;i<=LOGN;i++){
            up[u][i] = up[ up[u][i-1] ] ? up[ up[u][i-1] ][i-1] : 0;
        }
        adj[u].forEach(v=>{
            if(v===p) return;
            depth[v]=depth[u]+1;
            dist[v]=dist[u]+1; // 权重=1
            dfs(v,u);
        });
    }
    dfs(root,0);

    // LCA 查询可视化
    function LCA(a,b){
        let steps=[];
        if(depth[a]<depth[b]) [a,b]=[b,a];
        let diff=depth[a]-depth[b];
        for(let i=0;i<=LOGN;i++){
            if(diff&(1<<i)){
                steps.push(`节点 ${a} 向上跳 ${1<<i} 步 -> ${up[a][i]}`);
                a=up[a][i];
            }
        }
        if(a===b) return {lca:a,steps};
        for(let i=LOGN;i>=0;i--){
            if(up[a][i]!==up[b][i]){
                steps.push(`a=${a}, b=${b} 向上跳 ${1<<i}`);
                a=up[a][i];
                b=up[b][i];
            }
        }
        return {lca:up[a][0],steps};
    }

    let res=LCA(qa,qb);
    document.getElementById('log').innerHTML = `<b>LCA=${res.lca}</b><br>` + res.steps.join('<br>');

    // 画树
    let nodes=[], links=[];
    function build(u,p,x,y,dx){
        nodes.push({id:u,x,y});
        let cnt=adj[u].length-(p?1:0);
        let offset=-(cnt-1)/2;
        let idx=0;
        adj[u].forEach(v=>{
            if(v===p) return;
            let childX = x + (offset+idx)*dx;
            let childY = y + 100;
            links.push({source:u,target:v});
            build(v,u,childX,childY,dx/2);
            idx++;
        });
    }
    build(root,0,400,50,200);

    const svg=d3.select('#tree');
    svg.selectAll("*").remove();
    svg.selectAll('.link').data(links).enter().append('line')
        .attr('class','link')
        .attr('x1',d=>nodes.find(n=>n.id===d.source).x)
        .attr('y1',d=>nodes.find(n=>n.id===d.source).y)
        .attr('x2',d=>nodes.find(n=>n.id===d.target).x)
        .attr('y2',d=>nodes.find(n=>n.id===d.target).y);

    const g=svg.selectAll('.node').data(nodes).enter().append('g')
        .attr('class','node')
        .attr('transform',d=>`translate(${d.x},${d.y})`);
    g.append('circle').attr('r',20);
    g.append('text').text(d=>d.id).attr('dy',5).attr('text-anchor','middle');

    // up 表格
    let table="<tr><th>节点</th>";
    for(let i=0;i<=LOGN;i++) table+=`<th>2^${i}</th>`;
    table+="</tr>";
    for(let node in up){
        table+=`<tr><td>${node}</td>`;
        for(let i=0;i<=LOGN;i++) table+=`<td>${up[node][i]||0}</td>`;
        table+="</tr>";
    }
    document.getElementById('upTable').innerHTML = table;
}
</script>
</body>
</html>
